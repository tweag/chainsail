version: '3.5'
services:
  control-node:
    build:
      context: ../..
      dockerfile: docker/node/Dockerfile
    links:
      - mpi-node-1
      - mpi-node-2
    volumes:
      # Note: only the control node needs private key to spawn mpi processes
      # on other nodes via ssh.
      - $HOME/.ssh/your-resaas-key.pem:/root/.ssh/id.pem
      - $HOME/.ssh/your-resaas-key.pub:/app/config/ssh/authorized_keys
      - $PWD/config:/resaas
    command:
      - resaas-controller
      - --job
      - testing
      - --storage
      - /resaas/storage.yaml
      - --hostsfile
      - /resaas/hostsfile
      - --job-spec
      - /resaas/job.json
      - --config
      - /resaas/controller.yaml
    depends_on: [mpi-node-1, mpi-node-2]

  mpi-node-1:
    build:
      context: ../..
      dockerfile: docker/node/Dockerfile
    ports:
      - '26'
    volumes:
      - $HOME/.ssh/your-resaas-key.pub:/app/config/ssh/authorized_keys
      - $PWD/config:/resaas
    command:
      - /usr/sbin/sshd
      - -D

  mpi-node-2:
    ports:
      - '26'
    build:
      context: ../..
      dockerfile: docker/node/Dockerfile
    volumes:
      - $HOME/.ssh/your-resaas-key.pub:/app/config/ssh/authorized_keys
      - $PWD/config:/resaas
    command:
      - /usr/sbin/sshd
      - -D

  graphite:
    image: 'graphiteapp/graphite-statsd'
    restart: 'always'
    ports:
      - '80:80'
      - '2003-2004:2003-2004'
      - '2023-2024:2023-2024'
      - '8125:8125/udp'
      - '8126:8126'
